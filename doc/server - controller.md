# Server - Controller

# 模型

### 事件 - 客户端角度

* 注册新账号（主动）
	* 发送昵称、密码
	* 接收新账号
* 登陆（主动）
	* 发送账号、密码
	* 接受登陆成败信息，若成功则附带好友列表和离线消息，好友列表包括好友在线离线状态
	* 根据好友列表和离线消息更新好友数据库和消息数据库
* 请求添加好友（主动）
	* 发送甲方账号、乙方账号
	* 接收请求结果（非及时），包括通过、拒绝、忽略
	* 根据请求结果更新好友列表
* 处理添加好友请求（被动）
	* 接收甲方账号、甲方昵称
	* 发送处理结果，包括通过、拒绝、忽略
* 删除好友（主动）
	* 发送甲方账号、乙方账号
	* 接收删除结果（及时）
	* 根据删除结果更新好友列表，可能由于系统原因删除失败
* 发送消息（主动）
	* 发送甲方账号、乙方账号、消息
	* 接收消息收到确认（及时）
	* 根据发送结果更新消息数据库
* 接收消息（被动）
	* 接收乙方账号、消息
 	* 发送消息收到确认（及时）
	* 更新消息数据库
* 在线状态确认（被动）
	* 接收在线状态确认请求
	* 发送确认结果
	* 无其他操作
* 登出（主动）
	* 发送登出请求
	* 无接收
	* 退出

/*
* 好友登陆状态改变（被动）
	* 无发送
	* 好友登陆状态
	* 更新好友状态列表
*/

### 事件 - 服务器角度

* 注册新账号（被动）
	* 接收昵称、密码
	* 发送新账号
	* 更新账号数据库
* 登陆（被动）
	* 接收账号、密码
	* 发送登陆成败信息，若成功则附带好友列表和离线消息，好友列表包括好友在线离线状态
	* 更新登陆账号表、离线消息数据库
* 请求添加好友（被动） 处理添加好友请求（主动）
	* 从甲方接收甲方账号、乙方账号，从乙方接收处理结果（非及时）
	* 向乙方发送甲方账号、昵称，向甲方发送请求结果（非及时）
	* 更新好友数据库
* 删除好友（被动）
	* 接收甲方账号、乙方账号
	* 发送删除结果（及时）
	* 更新好友数据库
* 发送消息（被动） 接收消息（主动）
	* 从甲方接收甲方账号、乙方账号、消息，从乙方接收消息收到确认
	* 向乙方发送甲方账号、消息，向甲方发送消息收到确认
	* 更新消息数据库
* 在线状态确认（主动）
	* 发送在线状态确认请求
	* 接收确认结果
	* 根据确认结果更新登陆账号表
* 登出（被动）
	* 接收登出请求
	* 无发送
	* 更新登陆账号表
/*
* 好友登陆状态改变（主动）
	* 由账号登陆激发
	* 发送好友状态更新信息
	* 无
*/

### 属性

* 登陆账号表

### 通信

* 数据包

# 实现

### 模块

* 包接收器
* 包分发器
* 事件处理
 ** 登陆处理器：登陆：查询数据库、更新登陆表、返回登陆信息、返回离线信息、更新相关好友状态
	      下线：更新登陆表、更新相关好友状态
 ** 消息发送器：发送消息
 ** 消息接收器1（甲方）：激发消息发送器，添加离线信息
 ** 消息接收器2（乙方）：移除离线信息
 ** 账号管理器：修改数据库
 ** 好友管理器：修改数据库
 ** 账号状态处理器：间隔验证在线状态，更新登陆表

### 数据结构

##### 登陆账号表

```
class LoginAccountInfo {
	int id;
	String ip;
}
```

##### 数据包

```
class Package {
	int type;
	String ip;
}
```

```
class ClientPackage extends Package {
}

class CPCreateAccount extends ClientPackage {
}
```

```
class ServerPackage extends Package {
}

class SPCreateAccount extends ServerPackage {
}
```
